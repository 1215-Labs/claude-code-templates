# PRP: Obsidian Ecosystem Hub CI/CD Pipeline

**Date**: 2026-02-09
**Status**: Draft
**Complexity**: High (score 5+)
**Target Repo**: obsidian-ecosystem-hub

## Summary

Implement a GitHub Actions CI/CD pipeline for the obsidian-ecosystem-hub repository covering three domains: (1) Claude Code configuration validation (agents, commands, skills, hooks), (2) Python service quality (lint, type-check, test for obsidian-ai-agent and obsidian-brain), and (3) Docker image build and VPS deployment automation. The pipeline replaces the current fully manual `rsync + SSH + deploy.sh` workflow.

## Why This Is Complex

- **Multi-domain validation**: Config files (YAML/Markdown), Python services (FastAPI), Docker images, and shell scripts each need different validation strategies
- **Hybrid deployment target**: VPS with Docker Compose (not K8s), requiring SSH-based deployment
- **Secret management**: Multiple API keys (OpenAI, Slack, Google OAuth), database credentials, MinIO keys
- **Multiple Python services**: obsidian-ai-agent and obsidian-brain have separate codebases under `stack/`
- **No existing test infrastructure**: Config validation tests need to be created from scratch
- **Deployment rollback**: Current deploy.sh has backup logic but no automated rollback

## Context

### Current State
- **CI/CD**: None. All deployment is manual via `rsync -avz stack/ hostinger-vps:/root/stack/` then `ssh hostinger-vps "cd /root/stack && ./deploy.sh"`
- **Testing**: pytest configured in `stack/obsidian-ai-agent/pyproject.toml` but no CI runner
- **Type checking**: mypy strict + pyright strict configured but not enforced in CI
- **Linting**: Ruff configured but not enforced in CI
- **Config validation**: No automated checks for agent/command/skill YAML frontmatter
- **Docker builds**: Manual `docker compose build` on VPS
- **Secrets**: Stored in `.env` on VPS, generated by `deploy.sh` on first run

### Pain Points (from needs analysis)
- No validation gate before deployment — broken config can reach production
- Manual deployment requires SSH access and remembering multi-step procedures
- No way to catch Python type errors before deploying
- Config files (agents, commands, skills) have no structural validation
- Security: credentials were recently committed to git (2026-02-09 incident)

### Repository Structure (relevant paths)
```
obsidian-ecosystem-hub/
├── .claude/
│   ├── agents/*.md          # 13 agent definitions (YAML frontmatter)
│   ├── commands/**/*.md     # 9+ command definitions
│   ├── skills/*/SKILL.md    # 6+ skill definitions
│   ├── hooks/hooks.json     # Hook configuration
│   └── workflows/*.md       # 4 workflow definitions
├── stack/
│   ├── docker-compose.yml   # 16 services
│   ├── Caddyfile            # Reverse proxy config
│   ├── deploy.sh            # Deployment script
│   ├── obsidian-ai-agent/   # FastAPI service (Python 3.12+, uv)
│   │   ├── pyproject.toml   # Dependencies, ruff, mypy, pytest config
│   │   ├── app/             # Application code
│   │   └── tests/           # Test suite
│   ├── obsidian-brain/      # GraphRAG service (FastAPI)
│   └── scripts/
│       └── vault-sync.sh    # rclone sync script
├── .env.example             # Environment variable template
└── .github/workflows/       # TO BE CREATED
```

### Tech Stack Details
| Technology | Version | Config Location |
|-----------|---------|-----------------|
| Python | 3.12+ | .python-version |
| uv | latest | pyproject.toml |
| FastAPI | 0.120+ | pyproject.toml |
| Ruff | latest | pyproject.toml [tool.ruff] |
| mypy | strict | pyproject.toml [tool.mypy] |
| pyright | strict | pyproject.toml [tool.pyright] |
| pytest | latest | pyproject.toml [tool.pytest] |
| Docker Compose | v2 | stack/docker-compose.yml |
| Caddy | v2.10+ | stack/Caddyfile |

### VPS Details
| Property | Value |
|----------|-------|
| Host | hostinger-vps (SSH alias) |
| IP | 148.230.95.154 |
| Stack path | /root/stack/ |
| Docker services | 16 containers |
| Caddy | System service at /etc/caddy/Caddyfile |
| OS | Ubuntu (assumed) |

## Proposed Pipeline

### Workflow 1: `ci.yml` (runs on every PR and push to main)

```yaml
name: CI
on:
  pull_request:
  push:
    branches: [main]

jobs:
  config-validation:
    # Validate Claude Code configuration files
    # - Parse YAML frontmatter in agents/*.md
    # - Validate required fields (name, description, model)
    # - Check command $ARGUMENTS references
    # - Validate hooks.json structure
    # - Verify skill SKILL.md frontmatter

  python-lint:
    # Ruff check + format for each Python service
    # Matrix: [obsidian-ai-agent, obsidian-brain]

  python-typecheck:
    # mypy + pyright strict mode
    # Matrix: [obsidian-ai-agent, obsidian-brain]

  python-test:
    # pytest with coverage
    # Matrix: [obsidian-ai-agent, obsidian-brain]
    # Requires: postgres-vector service for integration tests

  docker-build:
    # Build Docker images (no push, just validate they build)
    # Only for services with Dockerfiles

  security-scan:
    # Scan for committed secrets (gitleaks or trufflehog)
    # Scan Python dependencies for vulnerabilities (pip-audit)

  docker-compose-validate:
    # Validate docker-compose.yml syntax
    # Check all referenced images exist
    # Validate Caddyfile syntax
```

### Workflow 2: `deploy.yml` (manual trigger or on release tag)

```yaml
name: Deploy to VPS
on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated, or "all")'
        default: 'all'
  release:
    types: [published]

jobs:
  deploy:
    # 1. Run full CI checks
    # 2. Build Docker images
    # 3. rsync stack/ to VPS via SSH
    # 4. SSH: run deploy.sh
    # 5. SSH: verify health checks pass
    # 6. If health check fails, rollback
```

### Workflow 3: `secret-scan.yml` (runs on every commit)

```yaml
name: Secret Scan
on: [push, pull_request]

jobs:
  gitleaks:
    # Run gitleaks to prevent credential commits
    # Block merge if secrets detected
```

## Implementation Tasks

### Task 1: Config Validation Script
**File**: `scripts/validate-config.py`
**Purpose**: Validate all Claude Code configuration files

Checks to implement:
1. Agent files: Parse YAML frontmatter, verify required fields (`name`, `description`), validate `model` is valid value
2. Command files: Verify files exist, check for `$ARGUMENTS` usage consistency
3. Skill files: Parse SKILL.md frontmatter, verify required fields
4. hooks.json: Validate JSON structure, verify referenced scripts exist, validate event types
5. Workflow files: Verify referenced commands/agents exist

### Task 2: CI Workflow
**File**: `.github/workflows/ci.yml`

Jobs:
1. `config-validation` — Run `scripts/validate-config.py`
2. `python-quality` — Matrix over Python services: ruff check, ruff format --check, mypy, pyright
3. `python-test` — Matrix over Python services: pytest --cov, require 80% coverage for new code
4. `docker-validate` — `docker compose -f stack/docker-compose.yml config --quiet`
5. `security` — gitleaks scan, pip-audit for Python deps

Service containers needed for tests:
- PostgreSQL with pgvector extension (for obsidian-agent integration tests)
- Redis/Valkey (for caching tests)

### Task 3: Deploy Workflow
**File**: `.github/workflows/deploy.yml`

Steps:
1. Checkout code
2. Run CI checks (reuse ci.yml via workflow_call)
3. Set up SSH agent with `VPS_SSH_KEY` secret
4. rsync stack/ to VPS
5. SSH: `cd /root/stack && ./deploy.sh`
6. SSH: `docker compose ps` and verify all services healthy
7. SSH: Run health check endpoints
8. On failure: SSH rollback to previous backup

GitHub Secrets required:
- `VPS_SSH_KEY` — SSH private key for hostinger-vps
- `VPS_HOST` — 148.230.95.154
- `VPS_USER` — root
- `VPS_STACK_PATH` — /root/stack

### Task 4: Secret Scanning
**File**: `.github/workflows/secret-scan.yml`

Use `gitleaks/gitleaks-action@v2` with custom `.gitleaks.toml` config to:
- Scan all commits in PRs
- Block merge if secrets detected
- Allow-list known false positives (MinIO example configs, test fixtures)

### Task 5: Coverage Reporting
Integrate `pytest-cov` output with GitHub PR comments:
- Use `pytest --cov --cov-report=xml`
- Upload to Codecov or use `orgoro/coverage` action for PR annotations
- Set minimum coverage threshold: 80% for new code

### Task 6: Branch Protection Rules
After CI is running, configure GitHub branch protection:
- Require CI to pass before merge
- Require secret scan to pass
- Require at least 1 approval for PRs touching `stack/`

## Dependencies

- GitHub repository with Actions enabled
- GitHub Secrets configured (VPS SSH key, host details)
- Python 3.12 available in CI runner
- uv package manager available in CI runner
- Docker and Docker Compose available in CI runner
- gitleaks available (GitHub Action)
- PostgreSQL with pgvector for integration test service containers

## Estimated Effort

| Task | Effort |
|------|--------|
| Config validation script | 2-3 hours |
| CI workflow | 2-3 hours |
| Deploy workflow | 2-3 hours |
| Secret scanning | 30 min |
| Coverage reporting | 1 hour |
| Branch protection | 30 min |
| Testing and iteration | 2-3 hours |
| **Total** | **~10-14 hours** |

## Acceptance Criteria

- [ ] All PRs run config validation, Python lint/typecheck/test, Docker validation, and secret scan
- [ ] Config validation catches malformed YAML frontmatter in agents/commands/skills
- [ ] Python services pass ruff, mypy, pyright in CI
- [ ] pytest runs with coverage reporting on PRs
- [ ] Secret scanning blocks commits containing credentials
- [ ] Manual deploy workflow can deploy to VPS with one click
- [ ] Deploy workflow verifies health after deployment
- [ ] Deploy workflow can rollback on failure
- [ ] Branch protection requires CI to pass before merge

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| pgvector not available in GitHub Actions | Use `pgvector/pgvector` Docker image as service container |
| SSH deployment from CI is fragile | Add retry logic, health check timeout, automatic rollback |
| Config validation too strict initially | Start with warnings, promote to errors incrementally |
| Secret scan false positives | Maintain `.gitleaks.toml` allow-list |
| VPS SSH key rotation | Document key rotation process, use GitHub environment secrets |

## References

- [GitHub Actions workflow syntax](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions)
- [gitleaks GitHub Action](https://github.com/gitleaks/gitleaks-action)
- [uv in GitHub Actions](https://docs.astral.sh/uv/guides/integration/github/)
- [pgvector Docker image](https://hub.docker.com/r/pgvector/pgvector)
- [pytest-cov documentation](https://pytest-cov.readthedocs.io/)
